# 共享配置片段
set $new_api_key "";
set $api_key "";
set $request_body "";
set $response_body "";
set $request_id "";

location /v1beta/ {
    lua_need_request_body on;

    access_by_lua_block {
        local key_validator = require "key_validator"
        local rate_limiter = require "rate_limiter"
        local logger = require "logger"

        ngx.var.request_id = ngx.var.pid .. "-" .. ngx.time() .. "-" .. math.random(1000, 9999)

        if not key_validator.validate_and_replace_key() then
            return
        end

        rate_limiter.check_rate_limit()

        if config.config.logging.log_request_body then
            ngx.var.request_body = logger.get_request_body()
        end
    }

    proxy_pass https://generativelanguage.googleapis.com;
    proxy_ssl_verify on;
    proxy_ssl_verify_depth 2;

    proxy_set_header Host generativelanguage.googleapis.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header x-goog-api-key $new_api_key;

    proxy_pass_request_headers on;
    proxy_request_buffering off;
    proxy_buffering off;
    proxy_cache off;

    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    proxy_hide_header x-goog-api-key;
    proxy_hide_header x-goog-gapi-key;

    body_filter_by_lua_block {
        local logger = require "logger"
        local config = require "config"

        if config.config.logging.log_response_body then
            local chunk = ngx.arg[1]
            local resp_body = ngx.var.response_body or ""

            if chunk then
                ngx.var.response_body = resp_body .. chunk
            end
        end
    }

    log_by_lua_block {
        local logger = require "logger"
        logger.log_request()
    }
}

location /health {
    access_log off;
    return 200 "OK\n";
    add_header Content-Type text/plain;
}

location /status {
    access_log off;
    stub_status on;
}