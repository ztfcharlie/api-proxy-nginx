server {
    listen 8888;
    server_name localhost;

    # 设置变量
    set $new_api_key "";
    set $api_key "";
    set $real_api_key_used "";
    set $request_body "";
    set $response_body "";

    # 生成请求ID
    set $request_id "";

    # 解析JSON请求体以获取更多信息（可选）
    lua_need_request_body on;

    location /v1beta/ {
        # 初始化
        access_by_lua_block {
            local key_validator = require "key_validator"
            local rate_limiter = require "rate_limiter"
            local logger = require "logger"
            local key_manager = require "key_manager"

            -- 生成请求ID
            ngx.var.request_id = ngx.var.pid .. "-" .. ngx.time() .. "-" .. math.random(1000, 9999)

            -- 定期重置key健康状态
            key_manager.reset_key_health()

            -- 验证和替换API Key
            local selected_key = key_validator.validate_and_replace_key()
            if not selected_key then
                return
            end

            -- 检查限流
            rate_limiter.check_rate_limit()

            -- 获取请求体用于日志记录
            if config.config.logging.log_request_body then
                ngx.var.request_body = logger.get_request_body()
            end
        }

        # 代理到Google Gemini API
        proxy_pass https://generativelanguage.googleapis.com;
        proxy_ssl_verify on;
        proxy_ssl_verify_depth 2;
        proxy_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;

        # 设置代理头
        proxy_set_header Host generativelanguage.googleapis.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 替换API Key
        proxy_set_header x-goog-api-key $new_api_key;

        # 保持客户端的Content-Type和其他头部
        proxy_pass_request_headers on;

        # 支持流式和非流式请求
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_cache off;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 响应头处理
        proxy_hide_header x-goog-api-key;
        proxy_hide_header x-goog-gapi-key;

        # 记录响应和Key状态
        body_filter_by_lua_block {
            local logger = require "logger"
            local config = require "config"
            local response_handler = require "response_handler"

            if config.config.logging.log_response_body then
                local chunk = ngx.arg[1]
                local resp_body = ngx.var.response_body or ""

                if chunk then
                    ngx.var.response_body = resp_body .. chunk
                end
            end

            -- 处理最后一块数据
            if ngx.arg[2] then
                response_handler.handle_quota_exceeded()
            end
        }

        # 记录日志和Key状态
        log_by_lua_block {
            local response_handler = require "response_handler"
            response_handler.handle_response()
            response_handler.key_health_monitor()
        }
    }

    # 健康检查端点
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # 状态端点
    location /status {
        access_log off;
        stub_status on;
    }

    # 错误页面
    error_page 401 /error401.html;
    error_page 403 /error403.html;
    error_page 429 /error429.html;
    error_page 500 502 503 504 /error50x.html;

    location = /error401.html {
        root html;
        internal;
    }

    location = /error403.html {
        root html;
        internal;
    }

    location = /error429.html {
        root html;
        internal;
    }

    location = /error50x.html {
        root html;
        internal;
    }
}

# HTTPS支持（可选）
server {
    listen 8443 ssl;
    server_name localhost;

    # SSL证书配置
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 其他配置与HTTP相同
    include conf.d/gemini-proxy-common.conf;
}