<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Proxy 管理后台</title>
    
    <!-- 样式库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus/dist/index.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 核心库 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus"></script>
    <script src="https://cdn.jsdelivr.net/npm/@element-plus/icons-vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        [v-cloak] { display: none; }
        .el-menu-vertical { height: 100vh; border-right: none; }
        .main-container { height: 100vh; display: flex; }
        .content-area { flex: 1; padding: 20px; background: #f3f4f6; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div class="main-container">
            <!-- 左侧菜单 -->
            <div class="w-64 bg-slate-800 text-white flex-shrink-0">
                <div class="h-16 flex items-center justify-center text-xl font-bold border-b border-slate-700">
                    Gemini Proxy
                </div>
                <el-menu
                    active-text-color="#ffd04b"
                    background-color="#1e293b"
                    class="el-menu-vertical"
                    default-active="channels"
                    text-color="#fff"
                    @select="handleSelect"
                >
                    <el-menu-item index="channels">
                        <el-icon><icon-connection /></el-icon>
                        <span>渠道管理 (Channels)</span>
                    </el-menu-item>
                    <el-menu-item index="tokens">
                        <el-icon><icon-key /></el-icon>
                        <span>令牌管理 (Tokens)</span>
                    </el-menu-item>
                    <el-menu-item index="users">
                        <el-icon><icon-user /></el-icon>
                        <span>用户管理 (Users)</span>
                    </el-menu-item>
                </el-menu>
            </div>

            <!-- 右侧内容区 -->
            <div class="content-area">
                
                <!-- 1. 渠道管理页面 -->
                <div v-if="currentTab === 'channels'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">渠道列表</h2>
                        <el-button type="primary" @click="openChannelDialog()">新增渠道</el-button>
                    </div>
                    
                    <el-card shadow="never">
                        <el-table :data="channels" style="width: 100%" v-loading="loading">
                            <el-table-column prop="id" label="ID" width="80"></el-table-column>
                            <el-table-column prop="name" label="名称"></el-table-column>
                            <el-table-column prop="type" label="类型">
                                <template #default="scope">
                                    <el-tag>{{ scope.row.type }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="status" label="状态">
                                <template #default="scope">
                                    <el-tag :type="scope.row.status ? 'success' : 'danger'">
                                        {{ scope.row.status ? '启用' : '禁用' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="200">
                                <template #default="scope">
                                    <el-button size="small" @click="openChannelDialog(scope.row)">编辑</el-button>
                                    <el-button size="small" type="danger" @click="deleteChannel(scope.row.id)">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </div>

                <!-- 2. 令牌管理页面 -->
                <div v-if="currentTab === 'tokens'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">虚拟令牌 (Virtual Tokens)</h2>
                        <el-button type="primary" @click="openTokenDialog()">创建新令牌</el-button>
                    </div>

                    <el-card shadow="never">
                        <el-table :data="tokens" style="width: 100%" v-loading="loading">
                            <el-table-column prop="id" label="ID" width="80"></el-table-column>
                            <el-table-column prop="name" label="名称"></el-table-column>
                            <el-table-column prop="username" label="所属用户"></el-table-column>
                            <el-table-column prop="type" label="协议类型"></el-table-column>
                            <el-table-column label="路由规则">
                                <template #default="scope">
                                    <div v-for="route in scope.row.routes" :key="route.channel_id" class="text-sm text-gray-600">
                                        {{ route.channel_name }} (权重: {{ route.weight }})
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="120">
                                <template #default="scope">
                                    <!-- 删除暂未实现 -->
                                    <el-button size="small" disabled>管理</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </div>
                
                <!-- 3. 用户管理页面 -->
                <div v-if="currentTab === 'users'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">用户管理</h2>
                        <el-button type="primary" @click="openUserDialog()">新增用户</el-button>
                    </div>
                    <el-card shadow="never">
                        <el-table :data="users" style="width: 100%" v-loading="loading">
                            <el-table-column prop="id" label="ID" width="80"></el-table-column>
                            <el-table-column prop="username" label="用户名"></el-table-column>
                            <el-table-column prop="status" label="状态">
                                <template #default="scope">
                                    <el-switch v-model="scope.row.status" :active-value="1" :inactive-value="0" disabled></el-switch>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </div>

            </div>
        </div>

        <!-- 渠道编辑弹窗 -->
        <el-dialog v-model="channelDialog.visible" :title="channelDialog.isEdit ? '编辑渠道' : '新增渠道'" width="600px">
            <el-form :model="channelForm" label-width="100px">
                <el-form-item label="名称">
                    <el-input v-model="channelForm.name" placeholder="如: Vertex US-Central"></el-input>
                </el-form-item>
                <el-form-item label="类型">
                    <el-select v-model="channelForm.type" placeholder="选择类型" class="w-full">
                        <el-option label="Google Vertex AI" value="vertex"></el-option>
                        <el-option label="Azure OpenAI" value="azure"></el-option>
                        <el-option label="OpenAI" value="openai"></el-option>
                        <el-option label="Anthropic Claude" value="anthropic"></el-option>
                    </el-select>
                </el-form-item>
                
                <el-form-item label="凭证" :label-width="100">
                    <el-input 
                        type="textarea" 
                        v-model="channelForm.credentials" 
                        :rows="6" 
                        :placeholder="channelForm.type === 'vertex' ? '粘贴 Service Account JSON' : '粘贴 API Key (sk-...)'">
                    </el-input>
                    <div class="text-xs text-gray-400 mt-1" v-if="channelForm.type === 'vertex'">必须是完整的 JSON 内容</div>
                </el-form-item>

                <!-- Azure 特有配置 -->
                <div v-if="channelForm.type === 'azure'" class="p-4 bg-gray-50 rounded mb-4">
                    <h4 class="text-sm font-bold mb-2 text-blue-600">Azure 配置</h4>
                    <el-form-item label="Endpoint" label-width="80px">
                        <el-input v-model="channelForm.extra_config.endpoint" placeholder="https://xxx.openai.azure.com"></el-input>
                    </el-form-item>
                    <el-form-item label="API Ver" label-width="80px">
                        <el-input v-model="channelForm.extra_config.api_version" placeholder="2023-05-15"></el-input>
                    </el-form-item>
                </div>

                <el-form-item>
                    <el-button type="success" @click="testConnection" :loading="testing">测试连接</el-button>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="channelDialog.visible = false">取消</el-button>
                <el-button type="primary" @click="saveChannel" :loading="saving">保存</el-button>
            </template>
        </el-dialog>

        <!-- 令牌创建弹窗 -->
        <el-dialog v-model="tokenDialog.visible" title="创建虚拟令牌" width="700px">
            <el-form :model="tokenForm" label-width="120px">
                <el-form-item label="归属用户">
                    <el-select v-model="tokenForm.user_id" placeholder="选择用户" class="w-full">
                        <el-option v-for="u in users" :key="u.id" :label="u.username" :value="u.id"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="名称备注">
                    <el-input v-model="tokenForm.name" placeholder="如: 生产环境Key"></el-input>
                </el-form-item>
                <el-form-item label="协议类型">
                    <el-select v-model="tokenForm.type" placeholder="选择协议" class="w-full" @change="handleTokenTypeChange">
                        <el-option label="Google Vertex (OAuth2)" value="vertex"></el-option>
                        <el-option label="OpenAI / Azure (Key)" value="azure"></el-option>
                    </el-select>
                </el-form-item>
                
                <!-- 路由选择 -->
                <el-form-item label="绑定渠道">
                    <div class="w-full">
                        <div v-for="(route, idx) in tokenForm.routes" :key="idx" class="flex gap-2 mb-2">
                            <el-select v-model="route.channel_id" placeholder="选择渠道" class="flex-1">
                                <el-option 
                                    v-for="c in availableChannels" 
                                    :key="c.id" 
                                    :label="c.name + ' (' + c.type + ')'" 
                                    :value="c.id">
                                </el-option>
                            </el-select>
                            <el-input-number v-model="route.weight" :min="1" :max="100" label="权重"></el-input-number>
                            <el-button type="danger" icon="Delete" circle @click="removeRoute(idx)"></el-button>
                        </div>
                        <el-button type="primary" plain size="small" @click="addRoute">+ 添加渠道 (负载均衡)</el-button>
                    </div>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="tokenDialog.visible = false">取消</el-button>
                <el-button type="primary" @click="createToken" :loading="saving">创建并生成 Key</el-button>
            </template>
        </el-dialog>
        
        <!-- 结果展示弹窗 -->
        <el-dialog v-model="resultDialog.visible" title="令牌生成成功" width="500px">
            <div class="bg-green-50 p-4 rounded">
                <p class="font-bold text-green-800 mb-2">请立即保存以下凭证，它不会再次显示！</p>
                <el-input 
                    type="textarea" 
                    :rows="10" 
                    v-model="resultDialog.content" 
                    readonly>
                </el-input>
            </div>
            <template #footer>
                <el-button type="primary" @click="resultDialog.visible = false">关闭</el-button>
            </template>
        </el-dialog>

    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed } = Vue;
        const { ElMessage } = ElementPlus;
        const icons = ElementPlusIconsVue;

        const app = createApp({
            setup() {
                const currentTab = ref('channels');
                const loading = ref(false);
                const saving = ref(false);
                const testing = ref(false);
                
                // 数据
                const channels = ref([]);
                const tokens = ref([]);
                const users = ref([]);
                
                // 渠道表单
                const channelDialog = reactive({ visible: false, isEdit: false });
                const channelForm = reactive({
                    id: null, name: '', type: 'vertex', credentials: '', 
                    extra_config: { endpoint: '', api_version: '' },
                    models_config: {}
                });

                // 令牌表单
                const tokenDialog = reactive({ visible: false });
                const tokenForm = reactive({
                    user_id: null, name: '', type: 'vertex', 
                    routes: [{ channel_id: null, weight: 10 }]
                });
                
                const resultDialog = reactive({ visible: false, content: '' });

                const API_BASE = '/api/admin'; // Node.js 代理路径

                // 初始化加载
                onMounted(() => {
                    loadChannels();
                });

                const handleSelect = (key) => {
                    currentTab.value = key;
                    if (key === 'channels') loadChannels();
                    if (key === 'tokens') { loadTokens(); loadUsers(); loadChannels(); }
                    if (key === 'users') loadUsers();
                };

                // --- Channels Logic ---
                const loadChannels = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.get(`${API_BASE}/channels`);
                        channels.value = res.data.data;
                    } catch (e) { ElMessage.error('加载失败'); }
                    loading.value = false;
                };

                const openChannelDialog = (row) => {
                    if (row) {
                        channelDialog.isEdit = true;
                        Object.assign(channelForm, row);
                        // 确保 extra_config 存在
                        if (!channelForm.extra_config) channelForm.extra_config = { endpoint: '', api_version: '' };
                        // 将 JSON 对象转回 extra_config
                        if (typeof channelForm.extra_config === 'string') channelForm.extra_config = JSON.parse(channelForm.extra_config);
                    } else {
                        channelDialog.isEdit = false;
                        channelForm.id = null;
                        channelForm.name = '';
                        channelForm.type = 'vertex';
                        channelForm.credentials = '';
                        channelForm.extra_config = { endpoint: '', api_version: '' };
                    }
                    channelDialog.visible = true;
                };

                const saveChannel = async () => {
                    saving.value = true;
                    try {
                        if (channelDialog.isEdit) {
                            await axios.put(`${API_BASE}/channels/${channelForm.id}`, channelForm);
                        } else {
                            await axios.post(`${API_BASE}/channels`, channelForm);
                        }
                        ElMessage.success('保存成功');
                        channelDialog.visible = false;
                        loadChannels();
                    } catch (e) { ElMessage.error(e.response?.data?.error || '保存失败'); }
                    saving.value = false;
                };
                
                const deleteChannel = async (id) => {
                    if(!confirm('确定删除吗？')) return;
                    try {
                        await axios.delete(`${API_BASE}/channels/${id}`);
                        ElMessage.success('已删除');
                        loadChannels();
                    } catch(e) { ElMessage.error(e.response?.data?.error || '删除失败'); }
                };

                const testConnection = async () => {
                    testing.value = true;
                    try {
                        const res = await axios.post(`${API_BASE}/channels/test-connection`, channelForm);
                        if (res.data.success) ElMessage.success(res.data.message);
                        else ElMessage.warning(res.data.message);
                    } catch(e) { ElMessage.error('测试出错'); }
                    testing.value = false;
                };

                // --- Tokens Logic ---
                const loadTokens = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.get(`${API_BASE}/tokens`);
                        tokens.value = res.data.data;
                    } catch(e) {}
                    loading.value = false;
                };

                const openTokenDialog = () => {
                    tokenForm.user_id = users.value.length > 0 ? users.value[0].id : null;
                    tokenForm.name = '';
                    tokenForm.type = 'vertex';
                    tokenForm.routes = [{ channel_id: null, weight: 10 }];
                    tokenDialog.visible = true;
                };

                // 过滤可用的 Channels (根据当前选的 type)
                const availableChannels = computed(() => {
                    // 这里做了简化，实际上不同类型的 channel 兼容性不同
                    // 比如 vertex type 的 token 只能绑 vertex 类型的 channel
                    // azure type 的 token 可以绑 azure 或 openai channel
                    if (tokenForm.type === 'vertex') {
                        return channels.value.filter(c => c.type === 'vertex');
                    } else {
                        return channels.value.filter(c => c.type !== 'vertex');
                    }
                });

                const handleTokenTypeChange = () => {
                    // 清空已选的不兼容渠道
                    tokenForm.routes.forEach(r => r.channel_id = null);
                };

                const addRoute = () => tokenForm.routes.push({ channel_id: null, weight: 10 });
                const removeRoute = (idx) => tokenForm.routes.splice(idx, 1);

                const createToken = async () => {
                    saving.value = true;
                    try {
                        // 过滤无效路由
                        const validRoutes = tokenForm.routes.filter(r => r.channel_id);
                        if(validRoutes.length === 0) {
                            ElMessage.warning('请至少选择一个渠道');
                            saving.value = false;
                            return;
                        }
                        
                        const payload = { ...tokenForm, routes: validRoutes };
                        const res = await axios.post(`${API_BASE}/tokens`, payload);
                        
                        // 显示结果
                        resultDialog.content = JSON.stringify(res.data.credentials, null, 2);
                        resultDialog.visible = true;
                        tokenDialog.visible = false;
                        loadTokens();
                    } catch(e) { ElMessage.error(e.response?.data?.error || '创建失败'); }
                    saving.value = false;
                };

                // --- Users Logic ---
                const loadUsers = async () => {
                    try {
                        const res = await axios.get(`${API_BASE}/users`);
                        users.value = res.data.data;
                    } catch(e) {}
                };
                const openUserDialog = async () => {
                     // 简单实现：直接弹个 prompt 演示
                     const name = prompt("请输入用户名");
                     if(name) {
                         await axios.post(`${API_BASE}/users`, { username: name, password: '123', remark: 'created via console' });
                         loadUsers();
                     }
                }

                return {
                    currentTab, handleSelect, loading, saving, testing,
                    channels, tokens, users,
                    channelDialog, channelForm, openChannelDialog, saveChannel, deleteChannel, testConnection,
                    tokenDialog, tokenForm, openTokenDialog, createToken, availableChannels, handleTokenTypeChange,
                    addRoute, removeRoute,
                    resultDialog, openUserDialog
                };
            }
        });

        // 注册图标
        for (const [key, component] of Object.entries(icons)) {
            app.component(key, component);
        }

        app.mount('#app');
    </script>
</body>
</html>
