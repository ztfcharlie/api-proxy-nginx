version: '3.8'

services:
  # 主要的 API 代理服务
  api-proxy-nginx:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: api-proxy-nginx
    restart: unless-stopped
    ports:
      - "8080:8080"   # HTTP 端口
      - "8443:8443"   # HTTPS 端口（如果启用）
    volumes:
      # 配置文件挂载
      - ./config:/usr/local/openresty/nginx/config:ro
      - ./data:/usr/local/openresty/nginx/data
      # 日志挂载
      - ./logs:/var/log/nginx
      # SSL 证书挂载（如果需要）
      - ./ssl:/usr/local/openresty/nginx/ssl:ro
      # 静态文件挂载（如果需要）
      - ./html:/usr/local/openresty/nginx/html:ro
    environment:
      # OpenResty 配置
      - WORKER_PROCESSES=auto
      - WORKER_CONNECTIONS=1024

      # Redis 配置
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}

      # 日志配置
      - LOG_LEVEL=info
      - DEBUG_MODE=false

      # 时区设置
      - TZ=Asia/Shanghai

      # 代理配置
      - PROXY_READ_TIMEOUT=300
      - PROXY_CONNECT_TIMEOUT=60

      # 令牌刷新配置
      - TOKEN_REFRESH_INTERVAL=3000
      - TOKEN_EARLY_REFRESH=300
    depends_on:
      - redis
    networks:
      - api-proxy-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.api-proxy.service=nginx"
      - "com.api-proxy.version=1.0.0"

  # Redis 缓存服务
  redis:
    image: redis:7-alpine
    container_name: api-proxy-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - ./redis-data:/data
      - ./redis/redis.conf:/etc/redis/redis.conf:ro
    command: >
      sh -c "
        if [ -f /etc/redis/redis.conf ]; then
          redis-server /etc/redis/redis.conf
        else
          redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
        fi
      "
    environment:
      - TZ=Asia/Shanghai
    networks:
      - api-proxy-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    labels:
      - "com.api-proxy.service=redis"

  # 日志聚合服务（可选，使用 profile 控制）
  fluentd:
    image: fluent/fluentd:v1.16-debian-1
    container_name: api-proxy-fluentd
    restart: unless-stopped
    ports:
      - "24224:24224"
      - "24224:24224/udp"
    volumes:
      - ./fluentd/conf:/fluentd/etc:ro
      - ./logs:/var/log/nginx:ro
      - ./fluentd-data:/var/log/fluentd
    environment:
      - FLUENTD_CONF=fluent.conf
      - TZ=Asia/Shanghai
    networks:
      - api-proxy-network
    profiles:
      - logging
    labels:
      - "com.api-proxy.service=fluentd"

# 网络配置
networks:
  api-proxy-network:
    driver: bridge
    name: api-proxy-network
