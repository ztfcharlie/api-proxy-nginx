version: '3.8'

services:
  # 1. Node.js 后台服务 (Admin API & OAuth2 Mock Generator)
  api-proxy-nodejs:
    build:
      context: ./nodejs
      dockerfile: Dockerfile
    container_name: api-proxy-nodejs
    restart: unless-stopped
    ports:
      - "${NODE_PORT}:3000" # Admin 端口 (宿主:容器)
    environment:
      # 连接基础服务
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      
      - PORT=3000 # 容器内部端口固定为 3000
      - TZ=${TZ}
    networks:
      - api-proxy-network
    depends_on:
      - api-proxy-mysql # 依赖基础服务中的数据库
      - api-proxy-redis

  # 2. Go Gateway (核心网关: 鉴权/计费/转发)
  api-proxy-gateway:
    build:
      context: ./go-gateway
      dockerfile: Dockerfile
    container_name: api-proxy-gateway
    restart: unless-stopped
    ports:
      - "${GATEWAY_PORT}:8080" # 网关入口端口 (宿主:容器)
    environment:
      - SERVER_PORT=8080 # 容器内部端口固定为 8080
      
      # 数据库连接
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      
      # 上游 Node.js 服务地址 (Docker 内部直接访问 3000)
      - NODE_BACKEND=http://api-proxy-nodejs:3000
      
      - TZ=${TZ}
    networks:
      - api-proxy-network
    depends_on:
      - api-proxy-nodejs

# 使用外部网络 (由 docker-compose-base-service.yml 创建)
networks:
  api-proxy-network:
    external: true