services:
  # OAuth2 模拟服务 (Node.js)
  api-proxy-nodejs:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: api-proxy-nodejs
    restart: unless-stopped
    user: "1001:1001"  # 使用nodejs用户
    ports:
      - "8889:8889"   # OAuth2 服务端口
      - "9090:9090"   # 监控端口（如果启用）
    volumes:
      # Node.js服务专用数据目录
      - ./logs:/app/logs
      - ./tmp:/app/tmp
      # 挂载 .env 文件到容器中（所有配置都在这里）
      - ../.env:/app/.env:ro
      # 挂载前端静态文件
      - ../web/public:/app/web/public
    networks:
      api-proxy-network:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8889/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    labels:
      - "com.api-proxy.service=oauth2-mock"
      - "com.api-proxy.version=1.0.0"

# 网络配置 - 连接到外部创建的基础服务网络
networks:
  api-proxy-network:
    external: true