<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Config Editor</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API Service
        const api = {
            get: async () => (await axios.get('/api/map-config')).data,
            save: async (data) => (await axios.post('/api/map-config', data)).data
        };

        // Components
        const Notification = ({ message, type, onClose }) => {
            useEffect(() => {
                if (message) {
                    const timer = setTimeout(onClose, 3000);
                    return () => clearTimeout(timer);
                }
            }, [message, onClose]);
            if (!message) return null;
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            return (
                <div className={`fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`}>
                    {message}
                    <button onClick={onClose} className="ml-4"><i className="fas fa-times"></i></button>
                </div>
            );
        };

        const TabButton = ({ active, onClick, children }) => (
            <button
                onClick={onClick}
                className={`px-4 py-2 font-medium rounded-t-lg ${active ? 'bg-white text-blue-600 border-t-2 border-blue-600' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}
            >
                {children}
            </button>
        );

        const JsonEditor = ({ data, onChange }) => {
            const [text, setText] = useState(JSON.stringify(data, null, 2));
            const [error, setError] = useState(null);

            useEffect(() => setText(JSON.stringify(data, null, 2)), [data]);

            const handleChange = (e) => {
                const newVal = e.target.value;
                setText(newVal);
                try {
                    const parsed = JSON.parse(newVal);
                    setError(null);
                    onChange(parsed);
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div>
                    <textarea
                        className={`w-full h-96 p-4 font-mono text-sm border rounded-lg ${error ? 'border-red-500' : 'border-gray-300'}`}
                        value={text}
                        onChange={handleChange}
                    ></textarea>
                    {error && <p className="text-red-500 mt-2">{error}</p>}
                </div>
            );
        };

        const ClientList = ({ clients, onChange }) => {
            const addClient = () => {
                const newClient = {
                    client_token: 'new-client-' + Date.now(),
                    enable: true,
                    service_type: 'google',
                    key_filename_gemini: []
                };
                onChange([...clients, newClient]);
            };

            const removeClient = (index) => {
                if (confirm('确定删除此客户端吗?')) {
                    const newClients = [...clients];
                    newClients.splice(index, 1);
                    onChange(newClients);
                }
            };

            const updateClient = (index, field, value) => {
                const newClients = [...clients];
                newClients[index] = { ...newClients[index], [field]: value };
                onChange(newClients);
            };
            
            const updateKeyConfig = (clientIndex, keyIndex, field, value) => {
                const newClients = [...clients];
                const newKeys = [...(newClients[clientIndex].key_filename_gemini || [])];
                newKeys[keyIndex] = { ...newKeys[keyIndex], [field]: value };
                newClients[clientIndex].key_filename_gemini = newKeys;
                onChange(newClients);
            };

             const addKeyConfig = (clientIndex) => {
                const newClients = [...clients];
                const newKeys = [...(newClients[clientIndex].key_filename_gemini || [])];
                newKeys.push({ key_filename: '', key_weight: 1 });
                newClients[clientIndex].key_filename_gemini = newKeys;
                onChange(newClients);
            };
            
            const removeKeyConfig = (clientIndex, keyIndex) => {
                const newClients = [...clients];
                const newKeys = [...(newClients[clientIndex].key_filename_gemini || [])];
                newKeys.splice(keyIndex, 1);
                newClients[clientIndex].key_filename_gemini = newKeys;
                onChange(newClients);
            };


            return (
                <div className="space-y-4">
                    <div className="flex justify-end">
                        <button onClick={addClient} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            <i className="fas fa-plus mr-2"></i>添加客户端
                        </button>
                    </div>
                    {clients.map((client, i) => (
                        <div key={i} className="bg-white p-4 rounded shadow border border-gray-200">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-bold mb-1">Client Token</label>
                                    <input
                                        type="text"
                                        className="w-full border p-2 rounded"
                                        value={client.client_token}
                                        onChange={(e) => updateClient(i, 'client_token', e.target.value)}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold mb-1">Service Type</label>
                                    <select
                                        className="w-full border p-2 rounded"
                                        value={client.service_type}
                                        onChange={(e) => updateClient(i, 'service_type', e.target.value)}
                                    >
                                        <option value="google">Google</option>
                                        <option value="azure">Azure</option>
                                        <option value="aws">AWS</option>
                                    </select>
                                </div>
                                <div className="flex items-center mt-6">
                                    <input
                                        type="checkbox"
                                        className="mr-2 h-5 w-5"
                                        checked={client.enable}
                                        onChange={(e) => updateClient(i, 'enable', e.target.checked)}
                                    />
                                    <label>启用</label>
                                    <button onClick={() => removeClient(i)} className="ml-auto text-red-500 hover:text-red-700">
                                        <i className="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div className="bg-gray-50 p-3 rounded">
                                <div className="flex justify-between mb-2">
                                    <h4 className="font-semibold text-sm text-gray-600">Key Filename Mappings</h4>
                                    <button onClick={() => addKeyConfig(i)} className="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">
                                        添加 Key
                                    </button>
                                </div>
                                {(client.key_filename_gemini || []).map((k, ki) => (
                                    <div key={ki} className="flex gap-2 mb-2 items-center">
                                        <input 
                                            placeholder="Filename" 
                                            className="border p-1 rounded flex-1 text-sm"
                                            value={k.key_filename}
                                            onChange={(e) => updateKeyConfig(i, ki, 'key_filename', e.target.value)}
                                        />
                                        <input 
                                            type="number"
                                            placeholder="Weight" 
                                            className="border p-1 rounded w-20 text-sm"
                                            value={k.key_weight}
                                            onChange={(e) => updateKeyConfig(i, ki, 'key_weight', parseInt(e.target.value))}
                                        />
                                        <button onClick={() => removeKeyConfig(i, ki)} className="text-red-500">
                                            <i className="fas fa-times"></i>
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };
        
        const GeminiKeysList = ({ keys, onChange }) => {
            const addKey = () => {
                onChange([...keys, { key_filename: 'new-key.json', models: [] }]);
            };

             const removeKey = (index) => {
                if (confirm('确定删除此Key配置吗?')) {
                    const newKeys = [...keys];
                    newKeys.splice(index, 1);
                    onChange(newKeys);
                }
            };

            const updateKey = (index, field, value) => {
                const newKeys = [...keys];
                newKeys[index] = { ...newKeys[index], [field]: value };
                onChange(newKeys);
            };
            
             const addModel = (keyIndex) => {
                const newKeys = [...keys];
                const newModels = [...(newKeys[keyIndex].models || [])];
                newModels.push({ model: 'gemini-pro', domain: 'us-central1-aiplatform.googleapis.com' });
                newKeys[keyIndex].models = newModels;
                onChange(newKeys);
            };
            
            const removeModel = (keyIndex, modelIndex) => {
                const newKeys = [...keys];
                newKeys[keyIndex].models.splice(modelIndex, 1);
                onChange(newKeys);
            };
            
            const updateModel = (keyIndex, modelIndex, field, value) => {
                const newKeys = [...keys];
                newKeys[keyIndex].models[modelIndex] = { ...newKeys[keyIndex].models[modelIndex], [field]: value };
                onChange(newKeys);
            };


            return (
                <div className="space-y-4">
                     <div className="flex justify-end">
                        <button onClick={addKey} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                            <i className="fas fa-plus mr-2"></i>添加 Key 配置
                        </button>
                    </div>
                    {keys.map((k, i) => (
                        <div key={i} className="bg-white p-4 rounded shadow border border-gray-200">
                            <div className="flex justify-between mb-4">
                                <div className="flex-1 mr-4">
                                     <label className="block text-sm font-bold mb-1">Key Filename</label>
                                    <input
                                        type="text"
                                        className="w-full border p-2 rounded"
                                        value={k.key_filename}
                                        onChange={(e) => updateKey(i, 'key_filename', e.target.value)}
                                    />
                                </div>
                                 <button onClick={() => removeKey(i)} className="text-red-500 hover:text-red-700 self-end mb-2">
                                    <i className="fas fa-trash"></i> 删除
                                </button>
                            </div>
                            
                             <div className="bg-gray-50 p-3 rounded">
                                <div className="flex justify-between mb-2">
                                    <h4 className="font-semibold text-sm text-gray-600">Models</h4>
                                    <button onClick={() => addModel(i)} className="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">
                                        添加 Model
                                    </button>
                                </div>
                                <div className="grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 mb-1">
                                    <div className="col-span-4">Model Name</div>
                                    <div className="col-span-7">Domain</div>
                                    <div className="col-span-1"></div>
                                </div>
                                {(k.models || []).map((m, mi) => (
                                    <div key={mi} className="grid grid-cols-12 gap-2 mb-2 items-center">
                                        <div className="col-span-4">
                                            <input 
                                                className="border p-1 rounded w-full text-sm"
                                                value={m.model}
                                                onChange={(e) => updateModel(i, mi, 'model', e.target.value)}
                                            />
                                        </div>
                                         <div className="col-span-7">
                                            <input 
                                                className="border p-1 rounded w-full text-sm"
                                                value={m.domain}
                                                onChange={(e) => updateModel(i, mi, 'domain', e.target.value)}
                                            />
                                        </div>
                                        <div className="col-span-1 text-right">
                                            <button onClick={() => removeModel(i, mi)} className="text-red-500">
                                                <i className="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const App = () => {
            const [config, setConfig] = useState({ clients: [], key_filename_gemini: [] });
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [tab, setTab] = useState('clients');
            const [notify, setNotify] = useState({ msg: '', type: '' });

            const load = async () => {
                try {
                    const data = await api.get();
                    setConfig(data);
                } catch (e) {
                    setNotify({ msg: 'Failed to load: ' + e.message, type: 'error' });
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { load(); }, []);

            const handleSave = async () => {
                setSaving(true);
                try {
                    await api.save(config);
                    setNotify({ msg: 'Saved successfully!', type: 'success' });
                } catch (e) {
                    setNotify({ msg: 'Failed to save: ' + e.message, type: 'error' });
                } finally {
                    setSaving(false);
                }
            };

            if (loading) return <div className="text-center mt-20">Loading...</div>;

            return (
                <div className="min-h-screen p-8">
                    <Notification message={notify.msg} type={notify.type} onClose={() => setNotify({ msg: '', type: '' })} />
                    
                    <div className="max-w-6xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
                        <div className="p-6 border-b bg-gray-50 flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-gray-800">Map Config Editor</h1>
                            <div className="space-x-2">
                                <button onClick={load} className="px-4 py-2 border rounded text-gray-600 hover:bg-gray-100">
                                    <i className="fas fa-sync mr-2"></i>Reload
                                </button>
                                <button onClick={handleSave} disabled={saving} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50">
                                    <i className="fas fa-save mr-2"></i>{saving ? 'Saving...' : 'Save Changes'}
                                </button>
                            </div>
                        </div>

                        <div className="p-6">
                            <div className="flex mb-4 border-b">
                                <TabButton active={tab === 'clients'} onClick={() => setTab('clients')}>Clients</TabButton>
                                <TabButton active={tab === 'gemini'} onClick={() => setTab('gemini')}>Gemini Keys</TabButton>
                                <TabButton active={tab === 'raw'} onClick={() => setTab('raw')}>Raw JSON</TabButton>
                            </div>

                            <div className="mt-4">
                                {tab === 'clients' && (
                                    <ClientList 
                                        clients={config.clients || []} 
                                        onChange={c => setConfig({...config, clients: c})} 
                                    />
                                )}
                                {tab === 'gemini' && (
                                    <GeminiKeysList 
                                        keys={config.key_filename_gemini || []} 
                                        onChange={k => setConfig({...config, key_filename_gemini: k})} 
                                    />
                                )}
                                {tab === 'raw' && (
                                    <JsonEditor 
                                        data={config} 
                                        onChange={setConfig} 
                                    />
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
