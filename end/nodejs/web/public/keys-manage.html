<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Key Manager</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        /* Custom Scrollbar for JSON view */
        .json-view::-webkit-scrollbar { width: 8px; height: 8px; }
        .json-view::-webkit-scrollbar-track { background: #f1f1f1; }
        .json-view::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .json-view::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API Service
        const api = {
            list: async () => (await axios.get('/api/service-keys')).data,
            upload: async (formData) => (await axios.post('/api/service-keys', formData, { headers: { 'Content-Type': 'multipart/form-data' } })).data,
            getContent: async (filename) => (await axios.get(`/api/service-keys/${filename}`)).data,
            rename: async (filename, newName) => (await axios.put(`/api/service-keys/${filename}`, { new_name: newName })).data,
            delete: async (filename) => (await axios.delete(`/api/service-keys/${filename}`)).data
        };

        // Components
        const Notification = ({ message, type, onClose }) => {
            useEffect(() => {
                if (message) {
                    const timer = setTimeout(onClose, 3000);
                    return () => clearTimeout(timer);
                }
            }, [message, onClose]);
            if (!message) return null;
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            return (
                <div className={`fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`}>
                    {message}
                    <button onClick={onClose} className="ml-4"><i className="fas fa-times"></i></button>
                </div>
            );
        };

        const Modal = ({ title, onClose, children, footer }) => (
            <div className="fixed inset-0 modal-backdrop flex items-center justify-center z-40 fade-in">
                <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 overflow-hidden flex flex-col max-h-[90vh]">
                    <div className="px-6 py-4 border-b flex justify-between items-center">
                        <h3 className="text-lg font-semibold">{title}</h3>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-700"><i className="fas fa-times"></i></button>
                    </div>
                    <div className="p-6 overflow-y-auto">
                        {children}
                    </div>
                    {footer && <div className="px-6 py-4 bg-gray-50 border-t flex justify-end gap-2">{footer}</div>}
                </div>
            </div>
        );

        const App = () => {
            const [files, setFiles] = useState([]);
            const [loading, setLoading] = useState(true);
            const [notify, setNotify] = useState({ msg: '', type: '' });
            const [viewFile, setViewFile] = useState(null); // { name: '', content: {} }
            const [renameFile, setRenameFile] = useState(null); // { oldName: '', newName: '' }
            const [showUpload, setShowUpload] = useState(false);
            
            const fileInputRef = useRef();

            const loadList = async () => {
                try {
                    setLoading(true);
                    const data = await api.list();
                    setFiles(data.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at)));
                } catch (e) {
                    setNotify({ msg: 'Failed to list files: ' + (e.response?.data?.error || e.message), type: 'error' });
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { loadList(); }, []);

            const handleUpload = async (e) => {
                e.preventDefault();
                const file = fileInputRef.current.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    await api.upload(formData);
                    setNotify({ msg: 'File uploaded successfully', type: 'success' });
                    setShowUpload(false);
                    loadList();
                } catch (e) {
                    setNotify({ msg: 'Upload failed: ' + (e.response?.data?.error || e.message), type: 'error' });
                }
            };

            const handleView = async (filename) => {
                try {
                    const content = await api.getContent(filename);
                    setViewFile({ name: filename, content: content });
                } catch (e) {
                    setNotify({ msg: 'Failed to read file: ' + (e.response?.data?.error || e.message), type: 'error' });
                }
            };

            const handleDelete = async (filename) => {
                if (!confirm(`Are you sure you want to delete "${filename}"? This cannot be undone.`)) return;
                try {
                    await api.delete(filename);
                    setNotify({ msg: 'File deleted', type: 'success' });
                    loadList();
                } catch (e) {
                    setNotify({ msg: 'Delete failed: ' + (e.response?.data?.error || e.message), type: 'error' });
                }
            };

            const handleRenameSubmit = async () => {
                if (!renameFile.newName) return;
                try {
                    await api.rename(renameFile.oldName, renameFile.newName);
                    setNotify({ msg: 'Renamed successfully', type: 'success' });
                    setRenameFile(null);
                    loadList();
                } catch (e) {
                    setNotify({ msg: 'Rename failed: ' + (e.response?.data?.error || e.message), type: 'error' });
                }
            };
            
            const formatSize = (bytes) => {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            };

            return (
                <div className="min-h-screen p-8">
                    <Notification message={notify.msg} type={notify.type} onClose={() => setNotify({ msg: '', type: '' })} />
                    
                    <div className="max-w-6xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
                        {/* Header */}
                        <div className="p-6 border-b bg-gray-50 flex justify-between items-center">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800">Service Key Manager</h1>
                                <p className="text-sm text-gray-500 mt-1">Directory: data/json/</p>
                            </div>
                            <div className="space-x-2">
                                <button onClick={loadList} className="px-4 py-2 border rounded text-gray-600 hover:bg-gray-100">
                                    <i className="fas fa-sync mr-2"></i>Refresh
                                </button>
                                <button onClick={() => setShowUpload(true)} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    <i className="fas fa-upload mr-2"></i>Upload JSON
                                </button>
                            </div>
                        </div>

                        {/* File List */}
                        <div className="p-6">
                            {loading ? (
                                <div className="text-center py-10 text-gray-500">Loading files...</div>
                            ) : files.length === 0 ? (
                                <div className="text-center py-10 text-gray-500 bg-gray-50 rounded border border-dashed">
                                    <i className="fas fa-folder-open text-4xl mb-3 text-gray-300"></i>
                                    <p>No JSON files found in the data directory.</p>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="min-w-full text-left text-sm">
                                        <thead>
                                            <tr className="border-b bg-gray-50">
                                                <th className="px-4 py-3 font-medium text-gray-600">Filename</th>
                                                <th className="px-4 py-3 font-medium text-gray-600">Size</th>
                                                <th className="px-4 py-3 font-medium text-gray-600">Last Modified</th>
                                                <th className="px-4 py-3 font-medium text-gray-600 text-right">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {files.map((file) => (
                                                <tr key={file.name} className="hover:bg-gray-50">
                                                    <td className="px-4 py-3 font-mono text-blue-600">{file.name}</td>
                                                    <td className="px-4 py-3 text-gray-500">{formatSize(file.size)}</td>
                                                    <td className="px-4 py-3 text-gray-500">{new Date(file.updated_at).toLocaleString()}</td>
                                                    <td className="px-4 py-3 text-right space-x-2">
                                                        <button onClick={() => handleView(file.name)} className="text-gray-500 hover:text-blue-600" title="View Content">
                                                            <i className="fas fa-eye"></i>
                                                        </button>
                                                        <button onClick={() => setRenameFile({ oldName: file.name, newName: file.name })} className="text-gray-500 hover:text-orange-500" title="Rename">
                                                            <i className="fas fa-edit"></i>
                                                        </button>
                                                        <button onClick={() => handleDelete(file.name)} className="text-gray-500 hover:text-red-600" title="Delete">
                                                            <i className="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Upload Modal */}
                    {showUpload && (
                        <Modal title="Upload Service Key" onClose={() => setShowUpload(false)} 
                            footer={
                                <>
                                    <button onClick={() => setShowUpload(false)} className="px-4 py-2 border rounded text-gray-600 hover:bg-gray-100">Cancel</button>
                                    <button onClick={handleUpload} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Upload</button>
                                </>
                            }>
                            <div className="space-y-4">
                                <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:bg-gray-50 transition-colors cursor-pointer"
                                     onClick={() => fileInputRef.current.click()}>
                                    <i className="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                    <p className="text-gray-600">Click to select a JSON file</p>
                                    <input 
                                        type="file" 
                                        ref={fileInputRef} 
                                        accept=".json" 
                                        className="hidden" 
                                        onChange={(e) => {
                                            if(e.target.files[0]) handleUpload(e);
                                        }}
                                    />
                                </div>
                                <p className="text-xs text-gray-500">Only .json files are allowed. The file will be validated before saving.</p>
                            </div>
                        </Modal>
                    )}

                    {/* View Modal */}
                    {viewFile && (
                        <Modal title={`File Content: ${viewFile.name}`} onClose={() => setViewFile(null)} 
                            footer={
                                <button onClick={() => setViewFile(null)} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Close</button>
                            }>
                            <div className="bg-gray-900 text-green-400 p-4 rounded font-mono text-xs overflow-auto max-h-[60vh] json-view">
                                <pre>{JSON.stringify(viewFile.content, null, 2)}</pre>
                            </div>
                        </Modal>
                    )}

                    {/* Rename Modal */}
                    {renameFile && (
                        <Modal title="Rename File" onClose={() => setRenameFile(null)}
                            footer={
                                <>
                                    <button onClick={() => setRenameFile(null)} className="px-4 py-2 border rounded text-gray-600 hover:bg-gray-100">Cancel</button>
                                    <button onClick={handleRenameSubmit} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Rename</button>
                                </>
                            }>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">New Filename</label>
                                <input 
                                    type="text" 
                                    className="w-full border rounded p-2" 
                                    value={renameFile.newName}
                                    onChange={(e) => setRenameFile({...renameFile, newName: e.target.value})}
                                    autoFocus
                                />
                                <p className="text-xs text-gray-500 mt-1">Must end with .json</p>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
